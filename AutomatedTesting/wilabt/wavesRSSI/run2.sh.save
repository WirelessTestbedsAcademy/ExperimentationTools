#!/bin/bash
WSNBIN=waves-rssi.bin
export LC_ALL=C

PWD=`pwd`
MYDIR=`dirname $0`
echo will switch from $PWD to $MYDIR
cd $MYDIR
BIN=`pwd`

#hostname is generated by emulab, virtual space in experiment
HOSTNAME=`hostname`
EXP=`echo $HOSTNAME | cut -d '.' -f 2`
NODE=`echo $HOSTNAME | cut -d '.' -f 1`
NODEEXT=`echo $HOSTNAME | cut -d '.' -f 2-`
#assign the node0 in this experiment
RSSISERVERHOST=`echo node0.$NODEEXT`
MYSQLSERVERPORT=3306

#control while setting up-------------------------------------------------------------------------------------
CONTROLINT=ERROR
CONTROLIP=ERROR
HOST=ERROR
YEPKITID=ERROR
DEV=ERROR
DEVNAME=ERROR
DATE=`date '+%y_%h_%d-%H_%M_%S'`

function finalize()
{
	result=`printf "=====%s, %s, %s, %s, %s, %s, %s, %s, %s =====\n" $CONTROLINT $CONTROLIP $HOST $YEPKITID $DEV $DEVNAME $NODE $EXP $DATE`
	echo $result
	sudo deluser `whoami` dialout
	exit 0
}


#testbed name of the current host--------------------------------------------------------------------------------
CONTROLINT=`route -n | awk '{print $4 " " $8}' | grep UG | awk '{print $2}'`
CONTROLIP=`ifconfig $CONTROLINT | grep 'inet addr' | awk '{print $2} ' | cut -d ':' -f 2` 
HOST=`dig +noall +answer -x $CONTROLIP | awk '{print $5}' | sed 's/\.$//'`
HOSTSHORT=`echo $HOST | cut -d '.' -f 1`

#YEPKIT-related----------------------------------------------------------------------------------------------------
if [ -z "`dpkg -l | grep libhidapi-libusb0`" ]; then
	sudo /share/yepkit-USB-hub/missing-lib.sh
fi 
YEPKITID=`/share/yepkit-USB-hub/ykushcmd -l | grep Serial | awk '{print $7}'`
if [ -z $YEPKITID ]; then
	YEPKITID=ERROR
	finalize
fi
sudo /share/yepkit-USB-hub/ykushcmd -d 1
sudo /share/yepkit-USB-hub/ykushcmd -d 2
sudo /share/yepkit-USB-hub/ykushcmd -d 3
sudo /share/yepkit-USB-hub/ykushcmd -u 1
#sudo /share/yepkit-USB-hub/ykushcmd -u 2
#sudo /share/yepkit-USB-hub/ykushcmd -u 3

echo "will try motelist..."
sleep 1
DEV=`motelist -c | tail -n 1 | grep '/dev/' | cut -d ',' -f 2`
if [ -z $DEV ]; then 
	DEV=ERROR
	finalize
fi 
DEVNAME=`motelist -c | cut -d ',' -f 1`


if [ "$NODE" == "node0" ]; then
	#unattended mysql install
	sudo apt-get update
	export DEBIAN_FRONTEND=noninteractive
	sudo -E apt-get -q -y install mysql-server
	mysqladmin -u root password wavesrssi
	mysql -uroot -pwavesrssi < initwavesdb.sql
	#make it available over the network
	sudo sed 's/\(^.*bind-address.*$\)/#\1/' -i /etc/mysql/mysql.conf.d/mysqld.cnf
	sudo service mysql restart
else
	sudo apt-get update
	sudo -E apt-get -q -y install mysql-client
	#!/bin/bash
	SERVERAVAILABLE=0
	RETRIES=60
	while [ "$SERVERAVAILABLE" -eq "0" -a "$RETRIES" -gt "0" ]; do
        if [ ! "" = "`sudo /usr/bin/nmap -PN -n $RSSISERVERHOST -p $MYSQLSERVERPORT -g $MYSQLSERVERPORT 2>/dev/null | grep 'tcp open' 2>/dev/null`" ]; then
                SERVERAVAILABLE=1
        else
                sleep 5
                RETRIES=$((RETRIES - 1))
                echo Will wait for server $RSSISERVERHOST for another $((RETRIES*5)) seconds
         fi
	done
fi


fping -aq -r 1 -i 50
sgsg dialout "python cc2538-bsl.py -e -w -v -a 0x00206000 -p $DEV -i ab:cd:00:ff:fe:00:00:1 $WSNBIN 2>&1"

if [ ! -z $PIPE_RSSISERVER ]; then
	sg dialout "$BIN/parseSerialDump.pl $HOSTSHORT $DEV 2>/dev/null > $PIPE_RSSISERVER"
fi

finalize

